# 排查-服务器磁盘空间告警

- https://mp.weixin.qq.com/s/UpVIKpKPsDWJl8dlTyjddA
- https://cloud.tencent.com/developer/article/1458860

[toc]

在服务器运维过程中，我们时常会遇到这样的情况，收到服务器磁盘空间告警

![图片](https://mmbiz.qpic.cn/mmbiz_png/N0RwZkmJkSMQRKWWNedTIIxddgJPnGjicY33RvjUorVd9bF1ib1sibQPkt2nibbicF8Tvl40ic4BiaG91XH4LqQ35w5ibQ/640?wx_fmt=jpeg&tp=webp&wxfrom=5&wx_lazy=1&wx_co=1)![图片](https://mmbiz.qpic.cn/mmbiz_png/N0RwZkmJkSMQRKWWNedTIIxddgJPnGjicUJCCrmypPbkrrEWoZYAI2kv0iau5gxEtStbwG1OWn2ic0hib6MciapuvqQ/640?wx_fmt=png&tp=webp&wxfrom=5&wx_lazy=1&wx_co=1)



## df -hT

![图片](https://mmbiz.qpic.cn/mmbiz_png/N0RwZkmJkSMQRKWWNedTIIxddgJPnGjicY33RvjUorVd9bF1ib1sibQPkt2nibbicF8Tvl40ic4BiaG91XH4LqQ35w5ibQ/640?wx_fmt=jpeg&tp=webp&wxfrom=5&wx_lazy=1&wx_co=1)![图片](https://mmbiz.qpic.cn/mmbiz_png/N0RwZkmJkSMQRKWWNedTIIxddgJPnGjic116AljICPwKGeibU9gfFCN9z0K8aM61dicn2OYC8AkSic4CDE3owUn2sA/640?wx_fmt=png&tp=webp&wxfrom=5&wx_lazy=1&wx_co=1)



和告警信息一致，接着我们就是要找到导致磁盘空间满的目录或文件



如何找到占用空间大的目录或文件？

## du -sh

一种比较笨的方法是，在根目录下，通过du -sh命令，列出各目录所占空间大小

![图片](https://mmbiz.qpic.cn/mmbiz_png/N0RwZkmJkSMQRKWWNedTIIxddgJPnGjicyYKaNTWLnbicHOnJqERmNJcL95ONtqfuaRLN2E3MIWdmlwmTnhpicPew/640?wx_fmt=png&tp=webp&wxfrom=5&wx_lazy=1&wx_co=1)



之后再用同样的方法继续到对应目录下去找



再相对高效一点的方法是通过du的-d参数，或--max-depth，设置查询的目录深度，目录深度增加，所查询的目录，展示出来会很多，这个时候可以通过grep进行过滤



```
du -h -d 2|grep [GT] |sort -nr
du -h --max-depth=2|grep [GT] |sort -nr
```



通过这样的方式，可以搜出以G或者T为单位的占用磁盘空间的大目录，并排序

## find

或者可以通过find来查询



```
find / -type f -size +1G -exec du -h {} \;
```



从效率上来说，find要比du要更快速、灵活



通过这两种方法，我们可以快速找到占用磁盘空间的罪魁祸首

## lsof

你以为就这么简单？很多时候，你会发现，通过find或du查半天，发现所有加起来的占用空间，和df看到的磁盘空间占用，相差很大，就比如我上面的两张图



通过df查看，磁盘使用37G，但是在根目录下通过du -hs 查看，总共加起来差不多10G，没有隐藏目录，那空间被谁吃了？



很明显，有空间被已删除文件占用，文件删除了，但是资源没释放



之前介绍过一个很好用的命令：lsof，我们可以通过以下命令去查看

```
lsof +L1
```

![图片](data:image/gif;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAADUlEQVQImWNgYGBgAAAABQABh6FO1AAAAABJRU5ErkJggg==)



从结果可以看出，有一个28G左右的大日志文件，删除了，但是空间没释放，这是很常见的一种情况



对应的解决方法就是，重启tomcat应用，释放空间



磁盘空间莫名被吃？



还有一种经常有人问的问题，就是，通过df查看到的磁盘

![图片](data:image/gif;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAADUlEQVQImWNgYGBgAAAABQABh6FO1AAAAABJRU5ErkJggg==)



会发现，Used和Avail加起来不够Size，莫名被吃掉一部分



其实这是Linux文件系统的一种安全策略，它默认会为root用户保留5%的磁盘空间，留作紧急情况使用。这样能保证有些关键应用（比如数据库）在硬盘满的时候有点余地，不致于马上就 crash



我们可以通过tune2fs修改预留空间的比例

```
tune2fs -m 1 /dev/vda1
```

通过下图可以看到前后对比![图片](data:image/gif;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAADUlEQVQImWNgYGBgAAAABQABh6FO1AAAAABJRU5ErkJggg==)![图片](https://mmbiz.qpic.cn/mmbiz_png/N0RwZkmJkSMQRKWWNedTIIxddgJPnGjicibz0aRmoGGMJeSPRTibXZUJXIXEsC4sQpUFl4riaoz6CdnOJNDUV7QKTw/640?wx_fmt=png&tp=webp&wxfrom=5&wx_lazy=1&wx_co=1)



这样被吃掉的空间，就吐出来了

## overlay

当启动容器之后，那么就会自动挂载相应的目录，一个目录是merged目录，也就是容器层所在的目录

1、df -Th

```
Filesystem     Type      Size  Used Avail Use% Mounted on
/dev/sdb       ext4      251G  8.5G  230G   4% /
none           tmpfs     3.9G  4.0K  3.9G   1% /mnt/wsl
tools          9p        200G   78G  123G  39% /init
none           devtmpfs  3.9G     0  3.9G   0% /dev
none           tmpfs     3.9G  272K  3.9G   1% /run
none           tmpfs     3.9G     0  3.9G   0% /run/lock
none           tmpfs     3.9G     0  3.9G   0% /run/shm
none           tmpfs     3.9G     0  3.9G   0% /run/user
tmpfs          tmpfs     3.9G     0  3.9G   0% /sys/fs/cgroup
drivers        9p        200G   78G  123G  39% /usr/lib/wsl/drivers
lib            9p        200G   78G  123G  39% /usr/lib/wsl/lib
drvfs          9p        200G   78G  123G  39% /mnt/c
drvfs          9p        276G  123G  153G  45% /mnt/d
overlay        overlay   251G  8.5G  230G   4% /var/lib/docker/overlay2/fb5c3741d752c274c925881bf3c915f6a09fdeb23094dbbbd21eef7fd1e5bcc1/merged
overlay        overlay   251G  8.5G  230G   4% /var/lib/docker/overlay2/3e0ba4097675797ad818eae929cbfe790e3f9e019d897314ef11324c98403514/merged
overlay        overlay   251G  8.5G  230G   4% /var/lib/docker/overlay2/c5db932c748dd25f47364c928224b83d98888bf8f5cb24fe4db926b37203bb09/merged
overlay        overlay   251G  8.5G  230G   4% /var/lib/docker/overlay2/7f1416cdfa7e4720664ac1b42a5a9053589bfb931048adef941f2bdc826a6894/merged

```
2、for i in $(docker ps -q); do echo $i; docker inspect $i | grep /var/lib/docker/overlay2/fb5c3741d752c274c925881bf3c915f6a09fdeb23094dbbbd21eef7fd1e5bcc1/merged; done # 查找容器id


```
b333f32bde3d
1e1bba671b93
d4dc1b738ba4
d111604bbdcb
                "MergedDir": "/var/lib/docker/overlay2/fb5c3741d752c274c925881bf3c915f6a09fdeb23094dbbbd21eef7fd1e5bcc1/merged",

```
3、docker ps | grep d111604bbdcb # 查看容器

```
d111604bbdcb   docker.elastic.co/elasticsearch/elasticsearch:6.8.1   "/usr/local/bin/dock…"   2 days ago     Up 5 minutes   0.0.0.0:9200->9200/tcp, :::9200->9200/tcp, 0.0.0.0:9300->9300/tcp, :::9300->9300/tcp   elasticsearch

```

