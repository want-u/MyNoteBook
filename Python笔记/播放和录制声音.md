# **播放和录制声音**
- https://cloud.tencent.com/developer/article/1431413
- https://www.jianshu.com/p/917b2ea7f719

[toc]

Python语言已经无所不能了，今天就来分享一下，如何使用Python来录制和播放音频文件。

下面是一些可以播放和录制音频的Python第三方库：

- playsound，支持MP3和WAV，目前只支持简单的回放。
- simpleaudio，支持WAV,提供检查文件是否仍在播放的功能。
- winsound，支持WAV,只支持windows。
- python-sounddevice和pyaudio为PortAudio库提供绑定，以便跨平台回放WAV文件。
- pydub，需要pyaudio来播放音频，但是安装了ffmpeg之后，它允许您使用几行代码来播放各种音频格式。

#### **一、播放音频文件**

##### **使用pyqt5库**

##### 方式一：QMediaPlayer,播放MP3（推荐）

QMediaPlayer是对本地计算机底层播放框架封装，依赖本地的播放框架，因此可播放格式受到限制，Windows上是DirectShow框架，安装LAV Filters之类的DirectShow解码框架可以支持更多的格式。所以**一般windows 只能播放常见的mp3 mp4格式，.avi 和 .wav格式可能无法播放。该类有设置播放位置接口。**DEMO如下：



```cpp
app = PyQt5.QtWidgets.QApplication(sys.argv)
url = PyQt5.QtCore.QUrl.fromLocalFile("yourfilepath")
content = PyQt5.QtMultimedia.QMediaContent(url)
player = PyQt5.QtMultimedia.QMediaPlayer()
player.setMedia(content)
player.setVolume(Sound_level)
player.play()
sys.exit(app.exec())
```

##### 方式二：QSound以及QSoundEffect,播放wav

简单地播放wav音频文件，使用QSound类方法即可，DEMO：



```php
app = PyQt5.QtWidgets.QApplication(sys.argv)
sound_file = 'triggers/waves/nock.wav'
sound = PyQt5.QtMultimedia.QSound(sound_file)
sound.play()
sys.exit(app.exec())
```

QSoundEffect可以用来播放无压缩的音频文件(如wav文件)，可对文件进行更多的操作，可用来播放交互音效，如提示音等。DEMO：



```python
app = PyQt5.QtWidgets.QApplication(sys.argv)
sound_file = 'test.wav'
sound = PyQt5.QtMultimedia.QSoundEffect()
sound.setSource(PyQt5.QtCore.QUrl.fromLocalFile(sound_file))
sound.setLoopCount(PyQt5.QtMultimedia.QSoundEffect.Infinite)
sound.setVolume(100)
sound.play()
app.exec()
```

以上两个类均可设置音量： setVolume()方法可以设置播放音频时的音量大小，参数为浮点型数值。1.0代表全音量播放，0.0代表静音；播放为 play(),停止为stop()。

##### 方式三：QAudioOutput

播放PCM音频（裸流）文件，最强大的方式。DEMO：



```kotlin
app = PyQt5.QtWidgets.QApplication(sys.argv)
format = PyQt5.QtMultimedia.QAudioFormat()
format.setChannelCount(1)
format.setSampleRate(1000)
format.setSampleSize(8)
format.setCodec("audio/pcm")
format.setByteOrder(QAudioFormat.LittleEndian)
format.setSampleType(QAudioFormat.UnSignedInt)
output = PyQt5.QtMultimedia.QAudioOutput(format)

rfile = PyQt5.QtCore.QFile()
rfile.setFileName("../test/19147_160913105347.adpcm")
rfile.open(PyQt5.QtCore.QIODevice.ReadOnly)
output.start(rfile)
app.exec()
```

##### **使用pygame库**

功能：播放音乐10秒后停止
```
import time
import pygame
file=r'C:\Users\chan\Desktop\Adele - All I Ask.mp3'
pygame.mixer.init()
print("播放音乐1")
track = pygame.mixer.music.load(file)

pygame.mixer.music.play()
time.sleep(10)
pygame.mixer.music.stop()
```

```
pygame.init() 进行全部模块的初始化，
pygame.mixer.init() 或者只初始化音频部分
pygame.mixer.music.load('xx.mp3') 使用文件名作为参数载入音乐 ,音乐可以是ogg、mp3等格式。载入的音乐不会全部放到内容中，而是以流的形式播放的，即在播放的时候才会一点点从文件中读取。
pygame.mixer.music.play()播放载入的音乐。该函数立即返回，音乐播放在后台进行。
play方法还可以使用两个参数
pygame.mixer.music.play(loops=0, start=0.0) loops和start分别代表重复的次数和开始播放的位置。
pygame.mixer.music.stop() 停止播放，
pygame.mixer.music.pause() 暂停播放。
pygame.mixer.music.unpause() 取消暂停。
pygame.mixer.music.fadeout(time) 用来进行淡出，在time毫秒的时间内音量由初始值渐变为0，最后停止播放。
pygame.mixer.music.set_volume(value) 来设置播放的音量，音量value的范围为0.0到1.0。
pygame.mixer.music.get_busy() 判断是否在播放音乐,返回1为正在播放。
pygame.mixer.music.set_endevent(pygame.USEREVENT + 1) 在音乐播放完成时，用事件的方式通知用户程序，设置当音乐播放完成时发送pygame.USEREVENT+1事件给用户程序。 pygame.mixer.music.queue(filename) 使用指定下一个要播放的音乐文件，当前的音乐播放完成后自动开始播放指定的下一个。一次只能指定一个等待播放的音乐文件。
```


##### **使用playsound库**

1、安装

```javascript
$ pip install playsound
```

2、使用播放音频

```javascript
from playsound import playsound
playsound('myfile.wav')
```

##### **使用simpleaudio库**

1、安装

```javascript
$ pip install simpleaudio
```

2、使用播放音频

```javascript
mport simpleaudio as sa

filename = 'myfile.wav'
wave_obj = sa.WaveObject.from_wave_file(filename)
play_obj = wave_obj.play()
play_obj.wait_done()  # Wait until sound has finished playing
```

##### **使用winsound库**

如果您使用Windows，您可以使用内置的winsound模块来访问其基本的声音播放机制。播放WAV文件可以在几行代码:

```javascript
import winsound

filename = 'myfile.wav'
winsound.PlaySound(filename, winsound.SND_FILENAME)
```

##### **使用python-sounddevice库**

1、安装

```javascript
$ pip install sounddevice
```

2、使用播放音频

```javascript
import sounddevice as sd
import soundfile as sf

filename = 'myfile.wav'
# Extract data and sampling rate from file
data, fs = sf.read(filename, dtype='float32')  
sd.play(data, fs)
status = sd.wait()  # Wait until file is done playing
```

##### **使用pydub库**

1、安装

```javascript
$ pip install pydub
```

2、使用播放音频

```javascript
from pydub import AudioSegment
from pydub.playback import play

sound = AudioSegment.from_wav('myfile.wav')
play(sound)
```

默认情况下，pydub只支持播放wav格式音频。如果你想播放更多其他格式的音频文件。需要安装ffmpeg-python。

```javascript
$ pip install ffmpeg-python
```

安装了ffmpeg后，播放MP3文件只需要在我们之前的代码中做一个小小的修改:

```javascript
from pydub import AudioSegment
from pydub.playback import play

sound = AudioSegment.from_mp3('myfile.mp3')
play(sound)
```

##### **使用pyaudio库**

1、安装

```javascript
$  pip install pyaudio
```

2、使用播放音频

```javascript
import pyaudio
import wave

filename = 'myfile.wav'


chunk = 1024   
wf = wave.open(filename, 'rb')
p = pyaudio.PyAudio()
stream = p.open(format = p.get_format_from_width(wf.getsampwidth()),
                channels = wf.getnchannels(),
                rate = wf.getframerate(),
                output = True)

data = wf.readframes(chunk)

while data != '':
    stream.write(data)
    data = wf.readframes(chunk)

stream.close()
p.terminate()
```

您可能已经注意到，使用pyaudio播放声音比使用前面看到的库播放声音要复杂一些。这意味着如果您只想在Python应用程序中播放声音效果，那么它可能不是您的首选。

但是，由于pyaudio提供了更低级的控制，因此可以获取和设置输入和输出设备的参数，并检查CPU负载和输入或输出延迟。

它还允许您在回调模式下播放和录制音频，在回调模式中，当需要回放新数据或记录可用数据时，将调用指定的回调函数。如果您的音频需要的不仅仅是简单的回放，那么这些选项使pyaudio成为一个合适的库。

既然您已经了解了如何使用许多不同的库来播放音频，现在就来看看如何使用Python自己录制音频。

#### **二、录音**

Python -sounddevice和pyaudio库提供了用Python录制音频的方法。

1 、使用python-sounddevice录音

```javascript
import sounddevice as sd
from scipy.io.wavfile import write

fs = 44100  # Sample rate
seconds = 3  # Duration of recording

myrecording = sd.rec(int(seconds * fs), samplerate=fs, channels=2)
sd.wait()  # Wait until recording is finished
write('output.wav', fs, myrecording)  # Save as WAV file 
```

2、使用pyaudio录音

```javascript
import pyaudio
import wave

chunk = 1024  # Record in chunks of 1024 samples
sample_format = pyaudio.paInt16  # 16 bits per sample
channels = 2
fs = 44100  # Record at 44100 samples per second
seconds = 3
filename = "output.wav"

p = pyaudio.PyAudio()  # Create an interface to PortAudio

print('Recording')

stream = p.open(format=sample_format,
                channels=channels,
                rate=fs,
                frames_per_buffer=chunk,
                input=True)

frames = []  # Initialize array to store frames

# Store data in chunks for 3 seconds
for i in range(0, int(fs / chunk * seconds)):
    data = stream.read(chunk)
    frames.append(data)

# Stop and close the stream 
stream.stop_stream()
stream.close()
# Terminate the PortAudio interface
p.terminate()

print('Finished recording')

# Save the recorded data as a WAV file
wf = wave.open(filename, 'wb')
wf.setnchannels(channels)
wf.setsampwidth(p.get_sample_size(sample_format))
wf.setframerate(fs)
wf.writeframes(b''.join(frames))
wf.close()
```

#### **三、保存和格式转换**

1、使用pydub保存音频

```javascript
from pydub import AudioSegment
sound = AudioSegment.from_wav('myfile.wav')
sound.export('myfile.mp3', format='mp3')
```

2、使用pydub完成格式转换

```javascript
from pydub import AudioSegment
sound = AudioSegment.from_wav('myfile.wav')
sound.export('myfile.mp3', format='mp3')
```

如果觉得内容还不错，分享给更多朋友，一起提升编程技能。