# 数据库 · 子查询
[toc]

## 子查询（多句合一句）
    含义：
        出现在其他语句中的select语句，称为子查询或内查询
        外部的查询语句，称为主查询或外查询
        
    分类：
        按子查询出现的位置：
            select后面：
                    仅仅支持标量子查询
            from后面：
                    支持表子查询
            where或having后面：⭐
                    支持标量子查询⭐
                    列子查询⭐
                    行子查询
            exists后面（相关子查询）：
                    支持表子查询
            
        按结果集的行列数不同：
            标量子查询（结果集只有一行一列）
            列子查询（结果集只有一列多行）
            行子查询（结果集有一行多列）
            表子查询（结果集一般为多行多列）
            
            
### 一、where或having后面

    1.标量子查询（单行子查询）
    2.列子查询（多行子查询）
    3.行子查询（多列多行）

    特点：
        ①子查询放在小括号内
        ②子查询一般放在条件的右侧
        ③标量子查询，一般搭配单行操作符：> < >= <= <>
        ④列子查询，一般搭配多行操作符：in/not in⭐,any/some,all
        ⑤子查询的执行优于与主查询，主查询的条件用到了子查询的结果
        in /=any
        not in/<>all
        
##### 1.标量子查询
    案例1：谁的工资比Abel高
    select salary
    from employees
    where last_name = 'Abel';
    
    select *
    from employees
    where salary>(
        select salary
        from employees
        where last_name = 'Abel'
    );
    
    案例2：返回job_id与141号员工相同，salary比143号员工多的员工的信息
    select last_name,job_id,salary
    from employees
    where job_id = (
        select job_id
        from employees
        where employee_id = 141)
    and salary > (
        select salary
        from employees
        where employee_id = 143);
        
    案例3：返回公司工资最少的员工信息
    select last_name,job_id , salary from employees 
    where salary = (
        select min(salary)
        from employees);
        
    案例4：查询最低工资大于50号部门最低工资的部门id和其最低工资
    select min(salary)
    from employees
    where department_id=50
    
    select min(salary),department_id
    from employees
    group by department_id
    
    select min(salary),department_id
    from employees
    group by department_id
    having min(salary)>(
        select min(salary)
        from employees
        where department_id=50);
        
##### 2.列子查询
    案例1：查询location_id是1400或1700的部门中所有员工的姓名
    select distinct department_id
    from departments
    where location_id in(1400,1700)
    
    select last_name 
    from employees
    where department_id in(
        select distinct department_id
        from departments
        where location_id in(1400,1700));
        
    案例2：返回其他工种中比job_id为‘IT_PROG’部门任一工资低的员工的工号，姓名
    select distinct salary
    from employees
    where job_id='IT_PROG'
    
    select employee_id,last_name,job_id,salary
    from employees
    where salary < any(
        select distinct salary
        from employees
        where job_id='IT_PROG')
    and job_id <> 'IT_PROG';
    或：select employee_id,last_name,job_id,salary
    from employees
    where salary < (
        select max(salary)
        from employees
        where job_id='IT_PROG')
    and job_id <> 'IT_PROG';
        
    案例3：返回其他工种中比job_id为‘IT_PROG’部门所有工资低的员工的工号，姓名
    select employee_id,last_name,job_id,salary
    from employees
    where salary < all(
        select distinct salary
        from employees
        where job_id='IT_PROG')
    and job_id <> 'IT_PROG';
    或：select employee_id,last_name,job_id,salary
    from employees
    where salary < (
        select min(salary)
        from employees
        where job_id='IT_PROG')
    and job_id <> 'IT_PROG';
    
##### 3.行子查询
    案例1：查询员工编号最小且工资最高的员工信息
    
    select min(employee_id)
    from employees
    
    select max(salary)
    from employees
    
    select * 
    from employees
    where employee_id=(
        select min(employee_id)
        from employees)
    and salary=(
        select max(salary)
        from employees);
        
    select *
    from employees
    where (employee_id,salary)=(
        select min(employee_id),max(salary)
        from employees);
        
二、select后面
    仅仅支持标量子查询

    案例：查询每个部门的员工个数
    select d.*,(
        select count(*) 
        from employees e
        where e.department_id=d.department_id
        )
    from departments d;
    
    案例2：查询员工号-102的部门名
    select (
        select department_name
        from departments d
        inner join employees e
        on d.department_id=e.department_id
        where e.employee_id=102
    ) 部门名;
    
### 三、from后面
    将子查询结果充当一张表，必须起别名
    
    案例：查询每个部门的平均工资的工资等级
    select avg(salary),department_id
    from employees
    group by department_id;
    
    select ag_dep.*,g.grade_level
    from (select avg(salary) ag,department_id
    from employees
    group by department_id) ag_dep
    inner join job_grades g
    on ag_dep.ag between lowest_sal and highest_sal;
    
### 四、exists后面
    语法：
        exists（完整的查询语句）
    结果：
        1或0

    select exists(select employee_id from employees);
    
    案例1：查询有员工的部门名
    select department_name
    from departments d
    where exists(
        select *
        from employees e
        where d.department_id=e.department_id);
        
    select department_name
    from departments d
    where d.department_id in(
        select department_id
        from emplouees);

    案例2：查询没有女朋友的男神信息
    select bo.*
    from boys
    where bo.id not in (
        select boyfriend_id
        from beauty);
        
    select bo.*
    from boys bo
    where not exists(
        select boyfriend_id
        from beauty b
        where bo.id=b.boyfriend_id);
        
##### 案例练习
    1.
    select department_id
    from employees
    where last_name = 'Zlotkey'
        
    select last_name,salary
    from employees
    where department_id = (
        select department_id
        from employees
        where last_name = 'Zlotkey');
        
    2.
    select avg(salary)
    from employees
    
    select last_name,employee_id,salary
    from employees
    where salary > (
        select avg(salary)
        from employees);
        
    3.
    select avg(salary),department_id
    from employees
    group by department_id;
    
    select employee_id,last_name,salary,e.department_id
    from employees e
    inner join(
        select avg(salary) ag,department_id
        from employees
        group by department_id
    ) ag_dep
    on e.department_id=ag_dep.department_id
    where salary>ag_dep.ag;
    
    4.
    select distinct department_id 
    from employees
    where last_name like '%u%'
    
    select employee_id,last_name
    from employees
    where department_id in (
        select distinct department_id 
        from employees
        where last_name like '%u%');
        
    5.
    select department_id
    from departments 
    where location_id=1700
    
    
    select employee_id
    from employees
    where department_id in (
        select department_id
        from departments 
        where location_id=1700);
    
    6.
    select manager_id
    from employees
    where last_name='King'
    
    select last_name,salary
    from employees
    where manager_id in (
        select employee_id
        from employees
        where last_name='K_ing');
        
    7.
    select max(salary)
    from employees
    
    select concat(first_name,,last_name) 
    "姓.名"
    from employees
    where salary = (
    select max(salary)
    from employees );
    